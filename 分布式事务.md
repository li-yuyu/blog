# 分布式事务

本地事务（单数据源事务），如MySQL 的 InnoDB 引擎通过 Undo Log 、 Redo Log来实现。

分布式事务（多数据源事务），本地事务无法保证跨多数据源全局操作可靠性。

## 二将军问题

![2](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/2.jpg)

## 分布式事务的模型

![1](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/1.png)

分布式事务中的角色：

- 协调者（事务管理器 Transaction Manager, TM），如图中shopping-service
- 参与者（资源管理器 Resource Manager, RM），如图中repo-service和order-service

分布式事务的本质：

事务协调者协调各个事务参与者的本地事务的进度，使使所有本地事务共同提交或回滚，最终达成一种全局的 ACID 特性

## 分布式事务的实现方案

### 刚性事务（强一致）

- 2PC 

  准备-提交，会锁定资源，二阶段提交前协调者宕机导致参与者阻塞，二阶段脑裂不一致。

- 3PC 

  询问-准备-提交，仍然会发生不一致，第二阶段加入超时机制，好处就是至少不会阻塞和永远锁定资源。

一个应用操作多个数据源进行2PC或3PC，为了保证强一致，所有子事务的数据库资源会被锁住。

### 柔性事务（弱一致）

- TCC 方案

TCC 模式本质是一个应用层面上的 2PC ，每个业务应用都实现Try-Confirm/Cancel 接口。

TCC 锁定的是业务资源，无需锁数据库资源，提高了吞吐量，应用实施成本较高。

![3](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/3.png)

通过补偿来解决二阶段宕机的问题，协调者不断重试、参与者实现幂等。

- 可靠消息最终一致性方案

![4](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/4.jpg)

![5](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/5.jpg)

![6](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/6.jpg)

应用实施成本较低，缺点是无法回滚

- 事务状态表方案

| 分布式事务 ID   | 事务内容                                                     | 事务状态                                                     |
| :-------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| global_trx_id_1 | 操作 1：调用 repo-service 扣减库存 <br />操作 2：调用 order-service 生成订单 | 状态 1：初始 <br />状态 2：操作 1 成功 <br />状态 3：操作 1、2 成功 |

启动一个后台任务，扫描这张表中事务的状态，重试一直未到最终状态的事务，接收方幂等处理。

- SAGA

  ![7](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/7.png)

Saga的执行顺序有两种：
T1, T2, T3, ..., Tn
T1, T2, ..., Tj, Cj,..., C2, C1，其中0 < j < n

Saga定义了两种恢复策略：
backward recovery，向后恢复，即上面提到的第二种执行顺序，其中j是发生错误的sub-transaction，这种做法的效果是撤销掉之前所有成功的sub-transation，使得整个Saga的执行结果撤销。
forward recovery，向前恢复，适用于必须要成功的场景，执行顺序是类似于这样的：T1, T2, ..., Tj(失败), Tj(重试),..., Tn，其中j是发生错误的sub-transaction。该情况下不需要Ci。

- 事务消息

  rocketMQ

  

## 处理分布式事务的原则

业务规避 > 柔性事务 > 刚性事务



## 讨论

你所落地实践过的分布式事务方案？选型？

核心系统（涉及资金等）用TCC，普通rocketMQ事务消息用的比较多，可调研下阿里开源seata。

![8](https://cdn.jsdelivr.net/gh/li-yuyu/notes/img/8.png)